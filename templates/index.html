<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Tarefas & Playground API</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        /* Custom Scrollbar for Logs */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800" x-data="taskApp()">

    <!-- Navbar -->
    <nav class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-2xl">üöÄ</span>
                <h1 class="text-xl font-bold">EasyPython Task Manager</h1>
            </div>
            <div class="space-x-4 text-sm">
                <a href="/api/docs/" target="_blank" class="hover:text-indigo-200 transition">üìÑ Swagger API</a>
                <a href="/admin/" target="_blank" class="hover:text-indigo-200 transition">üõ†Ô∏è Admin</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Coluna da Esquerda: Aplica√ß√£o -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Card de Nova Tarefa -->
                <div class="bg-white rounded-xl shadow-md p-6 border-t-4 border-indigo-500 relative group/card">
                    <!-- Help Tooltip POST -->
                    <div class="absolute top-4 right-4 text-gray-400 hover:text-indigo-600 cursor-help" title="Clique para saber mais" @click="showHelp('post')">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>

                    <h2 class="text-lg font-semibold mb-4 text-gray-700 flex items-center">
                        <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-2 font-mono text-sm">POST /api/tasks/</span>
                        Nova Tarefa
                    </h2>

                    <!-- Help Content -->
                    <div x-show="helpTopic === 'post'" x-transition class="mb-4 bg-indigo-50 p-4 rounded-lg border border-indigo-200 text-sm text-indigo-800" x-cloak>
                        <p class="font-bold mb-1">üìñ O que √© POST?</p>
                        <p>O m√©todo <strong>POST</strong> √© usado para <strong>enviar dados novos</strong> ao servidor. Neste formul√°rio, estamos empacotando o "T√≠tulo" e a "Descri√ß√£o" em um formato JSON e enviando para a API criar um novo registro no banco de dados.</p>
                    </div>

                    <form @submit.prevent="createTask" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo *</label>
                            <input type="text" x-model="newTask.title" placeholder="Ex: Aprender Django" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" required>
                            <p class="text-xs text-gray-400 mt-1">Par√¢metro obrigat√≥rio: `title` (string)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                            <textarea x-model="newTask.description" placeholder="Detalhes da tarefa..." rows="2"
                                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                            <p class="text-xs text-gray-400 mt-1">Par√¢metro opcional: `description` (string)</p>
                        </div>
                        <button type="submit" 
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex justify-center items-center gap-2"
                                :disabled="isLoading">
                            <span x-show="isLoading" class="animate-spin">‚åõ</span>
                            <span>Criar Tarefa (POST)</span>
                        </button>
                    </form>
                </div>

                <!-- Lista de Tarefas -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden relative">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <div class="flex items-center">
                            <h2 class="text-lg font-semibold text-gray-700 flex items-center">
                                <span class="bg-green-100 text-green-600 p-2 rounded-lg mr-2 font-mono text-sm">GET /api/tasks/</span>
                                Suas Tarefas
                            </h2>
                            <!-- Help Tooltip GET -->
                            <div class="ml-2 text-gray-400 hover:text-green-600 cursor-help" title="Clique para saber mais" @click="showHelp('get')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                        </div>
                        <button @click="fetchTasks" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                            üîÑ Atualizar Lista
                        </button>
                    </div>

                    <!-- Help Content -->
                    <div x-show="helpTopic === 'get'" x-transition class="bg-green-50 p-4 border-b border-green-200 text-sm text-green-800" x-cloak>
                        <p class="font-bold mb-1">üìñ O que √© GET?</p>
                        <p>O m√©todo <strong>GET</strong> solicita dados do servidor. A API retorna uma <strong>Lista (Array)</strong> de objetos JSON contendo todas as tarefas salvas. O navegador apenas "l√™" esses dados e desenha a lista abaixo.</p>
                    </div>

                    <div x-show="tasks.length === 0 && !isLoading" class="p-8 text-center text-gray-500" x-cloak>
                        <p class="mb-2">üì≠ Nenhuma tarefa encontrada.</p>
                        <p class="text-sm">Use o formul√°rio acima para criar a primeira!</p>
                    </div>

                    <ul class="divide-y divide-gray-200">
                        <template x-for="task in tasks" :key="task.id">
                            <li class="p-4 hover:bg-gray-50 transition duration-150 group">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start gap-3 flex-1">
                                        <!-- Checkbox (PATCH) -->
                                        <   class="mt-1 w-6 h-6 border-2 rounded flex-shrink-0 flex items-center justify-center transition-colors duration-200"
                                                ss="task.completed ? 'bg-green-500 border-green-500' : 'border-gray-300 hover:border-indigo-500'"
                                                e="Marcar como conclu√≠do (PATCH)">
                                            <svghow="task.completed" class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        </bu>
                                            <h3 class="text-lg font-medium text-gray-900" 
                                                    :class="{'line-through text-gray-400': task.completed}" 
                                                    x-text="task.title"></h3>
                                                <p class="text-gray-500 text-sm mt-1" x-text="task.description || 'Sem descri√ß√£o'"></p>
                                                <div class="mt-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <div class="relative group/tooltip">
                                                        <button @click="startEdit(task)" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">
                                                            ‚úèÔ∏è Editar (PUT)
                                                        </button>
                                                        <div class="absolute bottom-full mb-2 hidden group-hover/tooltip:block bg-gray-800 text-white text-xs p-2 rounded w-48 z-10">
                                                            <strong>PUT:</strong> Substitui o objeto inteiro. Enviamos t√≠tulo e descri√ß√£o atualizados para salvar.
                                                        </div>
                                                    </div>

                                                    <div class="relative group/tooltip">
                                                        <button @click="deleteTask(task.id)" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">
                                                            üóëÔ∏è Deletar (DELETE)
                                                        </button>
                                                        <div class="absolute bottom-full mb-2 hidden group-hover/tooltip:block bg-gray-800 text-white text-xs p-2 rounded w-48 z-10">
                                                            <strong>DELETE:</strong> Apaga o registro permanentemente usando o ID <code>/api/tasks/ID/</code>.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Modo Edi√ß√£o -->
                                            <div x-show="editingId === task.id" x-cloak class="bg-gray-50 p-3 rounded-lg border border-blue-200">
                                                <input type="text" x-model="editForm.title" class="w-full mb-2 px-2 py-1 border rounded text-sm">
                                                <textarea x-model="editForm.description" rows="2" class="w-full mb-2 px-2 py-1 border rounded text-sm"></textarea>
                                                <div class="flex justify-end gap-2">
                                                    <button @click="cancelEdit" class="text-xs text-gray-600 hover:text-gray-800">Cancelar</button>
                                                    <button @click="saveEdit(task.id)" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Salvar</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <span class="text-xs text-gray-400 font-mono" x-text="'ID: ' + task.id"></span>
                                </div>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>

            <!-- Coluna da Direita: Console / Logs -->
            <div class="lg:col-span-1">
                <div class="sticky top-6">
                    <div class="bg-gray-900 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col h-[600px]">
                        <div class="bg-gray-800 px-4 py-3 border-b border-gray-700 flex justify-between items-center">
                            <h3 class="text-gray-100 font-mono text-sm flex items-center">
                                <span class="text-green-400 mr-2">‚ûú</span> API Console Log
                            </h3>
                            <button @click="logs = []" class="text-xs text-gray-500 hover:text-gray-300">Limpar</button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-4 space-y-4 font-mono text-xs" id="console-logs">
                            <template x-if="logs.length === 0">
                                <div class="text-gray-600 text-center mt-10">
                                    <p>Nenhuma requisi√ß√£o feita ainda.</p>
                                    <p>Interaja com o app para ver os logs!</p>
                                </div>
                            </template>
                            
                            <template x-for="(log, index) in logs" :key="index">
                                <div class="border-b border-gray-800 pb-2 last:border-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-1.5 py-0.5 rounded text-[10px] font-bold"
                                              :class="{
                                                  'bg-green-900 text-green-300': log.method === 'GET',
                                                  'bg-indigo-900 text-indigo-300': log.method === 'POST',
                                                  'bg-blue-900 text-blue-300': log.method === 'PUT' || log.method === 'PATCH',
                                                  'bg-red-900 text-red-300': log.method === 'DELETE'
                                              }" x-text="log.method"></span>
                                        <span class="text-gray-300 break-all" x-text="log.url"></span>
                                        <span class="ml-auto text-[10px]" 
                                              :class="log.status >= 200 && log.status < 300 ? 'text-green-400' : 'text-red-400'"
                                              x-text="log.status"></span>
                                    </div>
                                    
                                    <!-- Payload (Se houver) -->
                                    <template x-if="log.payload">
                                        <div class="mb-1">
                                            <span class="text-gray-500 block">Payload (Enviado):</span>
                                            <pre class="text-indigo-300 overflow-x-auto whitespace-pre-wrap break-words" x-text="JSON.stringify(log.payload, null, 2)"></pre>
                                        </div>
                                    </template>

                                    <!-- Response -->
                                    <div>
                                        <span class="text-gray-500 block">Response (Recebido):</span>
                                        <pre class="text-yellow-100 overflow-x-auto whitespace-pre-wrap break-words" x-text="JSON.stringify(log.response, null, 2)"></pre>
                                    </div>
                                    <div class="text-gray-600 text-[10px] mt-1 text-right" x-text="log.time"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800">
                        <h4 class="font-bold flex items-center gap-2 mb-2">
                            <span>üí°</span> Dica de Auto Ajuda
                        </h4>
                        <p>Observe o console acima para entender como sua API funciona. Cada clique gera uma requisi√ß√£o HTTP real.</p>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-xs">
                            <li><strong>POST</strong>: Cria dados novos.</li>
                            <li><strong>GET</strong>: Busca dados.</li>
                            <li><strong>PATCH</strong>: Atualiza parte do dado (ex: s√≥ o status).</li>
                            <li><strong>DELETE</strong>: Remove dados.</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function taskApp() {
            return {
                tasks: [],
                helpTopic: null,                newTask: { title: '', description: '' },

                editingId: null,
                editForm: { title:s();
                },

                 howHelp'topic' {
                    this.helpTopic = this.helpTopic === topic ? null : topic, description: '' },
                isLoading: false,
                logs: [],

                init() {
                    this.fetchTasks();
                },

                // Fun√ß√£o auxiliar para logar no console visual
                addLog(method, url, status, payload, response) {
                    const time = new Date().toLocaleTimeString();
                    this.logs.unshift({ method, url, status, payload, response, time });
                    // Limitar a 20 logs para n√£o travar
                    if (this.logs.length > 20) this.logs.pop();
                },

                async apiCall(url, method = 'GET', body = null) {
                    const options = {
                        method: method,
                        headers: { 'Content-Type': 'application/json' }
                    };
                    if (body) options.body = JSON.stringify(body);

                    try {
                        const res = await fetch(url, options);
                        let data = null;
                        if (res.status !== 204) {
                            try { data = await res.json(); } catch(e) { data = {}; }
                        }
                        
                        this.addLog(method, url, res.status, body, data);
                        return { ok: res.ok, data };
                    } catch (error) {
                        this.addLog(method, url, 'ERROR', body, { error: error.message });
                        return { ok: false };
                    }
                },

                async fetchTasks() {
                    this.isLoading = true;
                    const { ok, data } = await this.apiCall('/api/tasks/');
                    if (ok) this.tasks = data;
                    this.isLoading = false;
                },

                async createTask() {
                    this.isLoading = true;
                    const { ok, data } = await this.apiCall('/api/tasks/', 'POST', this.newTask);
                    if (ok) {
                        this.tasks.unshift(data);
                        this.newTask = { title: '', description: '' };
                    }
                    this.isLoading = false;
                },

                async toggleTask(task) {
                    // C√≥pia para otimistic UI
                    const originalStatus = task.completed;
                    task.completed = !task.completed;

                    const { ok } = await this.apiCall(`/api/tasks/${task.id}/`, 'PATCH', { completed: task.completed });
                    
                    if (!ok) task.completed = originalStatus; // Reverte se falhar
                },

                async deleteTask(id) {
                    if (!confirm('Tem certeza que deseja apagar esta tarefa?')) return;
                    
                    const { ok } = await this.apiCall(`/api/tasks/${id}/`, 'DELETE');
                    if (ok) {
                        this.tasks = this.tasks.filter(t => t.id !== id);
                    }
                },

                startEdit(task) {
                    this.editingId = task.id;
                    this.editForm = { ...task };
                },

                cancelEdit() {
                    this.editingId = null;
                    this.editForm = { title: '', description: '' };
                },

                async saveEdit(id) {
                    const { ok, data } = await this.apiCall(`/api/tasks/${id}/`, 'PUT', this.editForm);
                    if (ok) {
                        // Atualiza a tarefa na lista local
                        const index = this.tasks.findIndex(t => t.id === id);
                        if (index !== -1) this.tasks[index] = data;
                        this.cancelEdit();
                    }
                }
            }
        }
    </script>
</body>
</html>
